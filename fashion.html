<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Fit Check | Rate My Drip</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
<div class="container fashion-page">
    <h1>Fit Check AI <span class="tag">Gen Z Mode</span></h1>
    <p id="status">Upload your outfit for AI-assisted analysis.</p>

    <div class="upload-zone">
        <input type="file" id="fashionUpload" accept="image/*" hidden>
        <label for="fashionUpload" class="btn-primary">Post to AI</label>
    </div>

    <div id="fashionPreview" class="preview-box">
        <img id="outfitImg" style="display:none; width:100%; border-radius:15px;">
    </div>

    <div id="fashionResults" style="display:none;">
        <div class="rating-display">
            <h2 id="fitScore">0/10</h2>
            <p id="styleLabel"></p>
            <p id="slangComment"></p>
        </div>
        <button onclick="location.href='index.html'" class="btn-secondary">
            Back to Face Scan
        </button>
    </div>
</div>

<script>
const BACKEND_URL = "https://YOUR_RENDER_BACKEND_URL/analyze";

const fashionUpload = document.getElementById("fashionUpload");
const slangComment = document.getElementById("slangComment");
const fitScore = document.getElementById("fitScore");
const status = document.getElementById("status");
const styleLabel = document.getElementById("styleLabel");

/* -------------------- AI CALL -------------------- */
async function analyzeWithHuggingFace(file) {
    const formData = new FormData();
    formData.append("file", file);

    try {
        const res = await fetch(BACKEND_URL, {
            method: "POST",
            body: formData
        });

        if (!res.ok) throw new Error("AI failed");
        return await res.json();
    } catch (err) {
        console.warn("AI unavailable, using fallback logic");
        return null;
    }
}

/* -------------------- UPLOAD HANDLER -------------------- */
fashionUpload.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    status.innerText = "Uploading image...";

    reader.onload = async (event) => {
        const img = new Image();
        img.src = event.target.result;

        img.onload = async () => {
            document.getElementById("outfitImg").src = img.src;
            document.getElementById("outfitImg").style.display = "block";

            status.innerText = "Analyzing outfit composition...";

            const color = getAverageRGB(img);
            const vibe = getColorVibe(color.r, color.g, color.b);

            status.innerText = "Consulting AI stylist...";
            const hfData = await analyzeWithHuggingFace(file);
            const tags = hfData ? hfData.map(x => x.label.toLowerCase()) : [];

            /* -------- SCORE -------- */
            let score = 5;
            if (tags.includes("jacket")) score += 2;
            if (tags.includes("sneakers")) score += 2;
            if (tags.length >= 3) score += 1;

            score += vibe.score - 5;
            score = Math.max(1, Math.min(10, score));

            /* -------- STYLE LABEL -------- */
            let style = "Casual Clean";
            if (vibe.score >= 8 && color.r < 80) style = "Streetwear Core";
            else if (vibe.score >= 7 && color.r > color.b) style = "Minimal / Old Money";
            else if (vibe.score >= 8) style = "Statement Fit";

            setTimeout(() => {
                fitScore.innerText = `${score}/10`;
                styleLabel.innerText = `Style: ${style}`;
                slangComment.innerText =
                    `${hfData ? "AI-assisted analysis" : "Visual analysis"} â€” ${vibe.comment}`;

                document.querySelector(".rating-display").style.borderColor =
                    `rgb(${color.r},${color.g},${color.b})`;

                document.getElementById("fashionResults").style.display = "block";
                status.innerText = "Vibe check complete.";
            }, 1200);
        };
    };
    reader.readAsDataURL(file);
});

/* -------------------- COLOR LOGIC -------------------- */
function getAverageRGB(imgEl) {
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");
    canvas.width = 50;
    canvas.height = 50;
    ctx.drawImage(imgEl, 0, 0, 50, 50);

    const data = ctx.getImageData(0, 0, 50, 50).data;
    let r = 0, g = 0, b = 0;

    for (let i = 0; i < data.length; i += 4) {
        r += data[i];
        g += data[i+1];
        b += data[i+2];
    }

    const pixels = data.length / 4;
    return { r: r/pixels, g: g/pixels, b: b/pixels };
}

/* -------------------- VIBE -------------------- */
function getColorVibe(r, g, b) {
    if (r < 60 && g < 60 && b < 60)
        return { score: 9, comment: "Dark palette, heavy aura. Street-certified." };
    if (r > 200 || g > 200 || b > 200)
        return { score: 8, comment: "Bright tones, confident presence." };
    if (r > g && g > b)
        return { score: 7, comment: "Earth tones, understated elegance." };
    return { score: 6, comment: "Balanced, clean, everyday drip." };
}
</script>
</body>
</html>
