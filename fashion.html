<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Fit Check AI | Vibe Analysis</title>
<link rel="stylesheet" href="style.css">
</head>

<body>
<div class="container fashion-page">
    <h1>Fit Check AI <span class="tag">v2</span></h1>
    <p id="status">Upload your outfit for AI-assisted analysis.</p>

    <div class="upload-zone">
        <input type="file" id="fitA" accept="image/*" hidden>
        <label for="fitA" class="btn-primary">Upload Fit A</label>

        <input type="file" id="fitB" accept="image/*" hidden>
        <label for="fitB" class="btn-secondary">Upload Fit B (Optional)</label>
    </div>

    <div class="preview-box">
        <img id="imgA" style="display:none;">
        <img id="imgB" style="display:none;">
    </div>

    <div id="results" style="display:none;">
        <div class="rating-display">
            <h2 id="score">0/10</h2>
            <p id="style"></p>
            <p id="caption"></p>
            <ul id="tips"></ul>
            <p id="comparison"></p>
        </div>
    </div>
</div>

<script>
const BACKEND_URL = "https://looksly.vercel.app/api/analyze";

let fitData = {};

async function analyzeAI(file) {
    const formData = new FormData();
    formData.append("file", file);

    try {
        const res = await fetch(BACKEND_URL, {
            method: "POST",
            body: formData
        });
        if (!res.ok) throw new Error();
        return await res.json();
    } catch {
        return null;
    }
}

function analyzeImage(img, tags = []) {
    const color = getAverageRGB(img);
    const vibe = getColorVibe(color);

    let score = vibe.score;
    if (tags.length >= 3) score += 1;
    score = Math.min(10, Math.max(1, score));

    const style = getStyle(vibe, color);
    const tips = getTips(vibe, tags);
    const caption = getCaption(style, score);

    return { score, style, tips, caption };
}

/* -------- UPLOAD HANDLERS -------- */
document.getElementById("fitA").addEventListener("change", async e => {
    await handleFit(e.target.files[0], "A");
});
document.getElementById("fitB").addEventListener("change", async e => {
    await handleFit(e.target.files[0], "B");
});

async function handleFit(file, label) {
    const reader = new FileReader();
    reader.onload = async e => {
        const img = new Image();
        img.src = e.target.result;
        img.onload = async () => {
            document.getElementById("img"+label).src = img.src;
            document.getElementById("img"+label).style.display = "block";

            const ai = await analyzeAI(file);
            const tags = ai ? ai.map(x => x.label.toLowerCase()) : [];

            fitData[label] = analyzeImage(img, tags);

            if (fitData.A) renderResults();
        };
    };
    reader.readAsDataURL(file);
}

function renderResults() {
    const A = fitData.A;
    const B = fitData.B;

    document.getElementById("score").innerText = `${A.score}/10`;
    document.getElementById("style").innerText = `Style: ${A.style}`;
    document.getElementById("caption").innerText = `"${A.caption}"`;

    const tipsEl = document.getElementById("tips");
    tipsEl.innerHTML = "";
    A.tips.forEach(t => {
        const li = document.createElement("li");
        li.innerText = t;
        tipsEl.appendChild(li);
    });

    if (B) {
        document.getElementById("comparison").innerText =
            A.score >= B.score
            ? "Fit A wins. Cleaner execution and stronger presence."
            : "Fit B wins. Better balance and styling choices.";
    }

    document.getElementById("results").style.display = "block";
}

/* -------- STYLE LOGIC -------- */
function getStyle(vibe, color) {
    if (vibe.score >= 8 && color.dark) return "Streetwear Core";
    if (vibe.score >= 8) return "Statement Fit";
    if (color.earthy) return "Minimal / Old Money";
    return "Casual Clean";
}

function getTips(vibe, tags) {
    const tips = [];
    if (vibe.score < 7) tips.push("Increase contrast to elevate the fit.");
    if (!tags.includes("jacket")) tips.push("Layering could add depth.");
    if (tags.length < 2) tips.push("Consider mixing textures or pieces.");
    return tips.length ? tips : ["Well-balanced outfit. No major changes needed."];
}

function getCaption(style, score) {
    const captions = {
        "Streetwear Core": ["Dark tones, louder confidence.", "Street energy activated."],
        "Statement Fit": ["Main character energy unlocked.", "Not subtle. Intentional."],
        "Minimal / Old Money": ["Quiet flex, loud taste.", "Clean lines, calm confidence."],
        "Casual Clean": ["Effortless and put together.", "Simple done right."]
    };
    return captions[style][score % captions[style].length];
}

/* -------- COLOR -------- */
function getAverageRGB(img) {
    const c = document.createElement("canvas");
    const x = c.getContext("2d");
    c.width = c.height = 50;
    x.drawImage(img,0,0,50,50);
    const d = x.getImageData(0,0,50,50).data;
    let r=0,g=0,b=0;
    for(let i=0;i<d.length;i+=4){r+=d[i];g+=d[i+1];b+=d[i+2];}
    r/=2500; g/=2500; b/=2500;
    return {
        r,g,b,
        dark: r<80 && g<80 && b<80,
        earthy: r>g && g>b
    };
}

function getColorVibe(color) {
    if (color.dark) return { score: 9 };
    if (color.r>200 || color.g>200 || color.b>200) return { score: 8 };
    if (color.earthy) return { score: 7 };
    return { score: 6 };
}
</script>
</body>
</html>
